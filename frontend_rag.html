<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Médica CIE-10-ES con RAG | RICOH España</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Colores corporativos de RICOH */
        .ricoh-red { background-color: #DC143C; }
        .ricoh-red-text { color: #DC143C; }
        .ricoh-red-border { border-color: #DC143C; }
        .ricoh-red-hover:hover { background-color: #B22222; }
        
        .ricoh-dark-red { background-color: #8B0000; }
        .ricoh-dark-red-text { color: #8B0000; }
        .ricoh-dark-red-border { border-color: #8B0000; }
        .ricoh-dark-red-hover:hover { background-color: #660000; }
        
        .ricoh-gray { background-color: #F5F5F5; }
        .ricoh-dark-gray { background-color: #333333; }
        .ricoh-dark-gray-text { color: #333333; }
        
        /* Gradiente corporativo RICOH */
        .ricoh-gradient { 
            background: linear-gradient(135deg, #DC143C 0%, #B22222 50%, #8B0000 100%); 
        }
        
        /* Efectos hover corporativos */
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(220, 20, 60, 0.15); 
        }
        
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Botones corporativos */
        .btn-ricoh-primary {
            background-color: #DC143C;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-ricoh-primary:hover {
            background-color: #B22222;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.3);
        }
        
        .btn-ricoh-secondary {
            background-color: #8B0000;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-ricoh-secondary:hover {
            background-color: #660000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
        }
        
        /* Inputs corporativos */
        .input-ricoh:focus {
            border-color: #DC143C;
            box-shadow: 0 0 0 3px rgba(220, 20, 60, 0.1);
        }
        
        /* Badges corporativos */
        .badge-ricoh-red {
            background-color: #DC143C;
            color: white;
        }
        
        .badge-ricoh-dark-red {
            background-color: #8B0000;
            color: white;
        }
        
        .badge-ricoh-success {
            background-color: #28A745;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header Corporativo RICOH -->
    <header class="ricoh-gradient text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Logo RICOH simplificado -->
                    <div class="flex items-center space-x-3">
                                             <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                         <span class="text-2xl font-bold ricoh-red-text">R</span>
                     </div>
                        <div>
                            <h1 class="text-2xl font-bold">RICOH</h1>
                            <p class="text-blue-100 text-sm">IA Médica CIE-10-ES</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                                         <div class="badge-ricoh-red px-3 py-1 rounded-full text-xs font-medium">
                         <i class="fas fa-brain mr-1"></i>RAG Activo
                     </div>
                    <div class="badge-ricoh-success px-3 py-1 rounded-full text-xs font-medium">
                        <i class="fas fa-check mr-1"></i>Online
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formulario Principal -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-6">
                                                 <i class="fas fa-stethoscope text-2xl ricoh-red-text mr-3"></i>
                        <h2 class="text-xl font-semibold ricoh-dark-gray-text">Codificación Médica Inteligente</h2>
                    </div>

                    <!-- Formulario -->
                    <form id="codificacionForm" class="space-y-6">
                                                <div>
                            <label class="block text-sm font-medium ricoh-dark-gray-text mb-2">
                                <i class="fas fa-user-md mr-2 ricoh-red-text"></i>Diagnóstico del Paciente
                            </label>
                            <textarea 
                                id="diagnostico" 
                                name="diagnostico" 
                                rows="4" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg input-ricoh resize-none"
                                placeholder="Ej: Paciente de 65 años con diabetes mellitus tipo 2 descompensada..."
                                required
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium ricoh-dark-gray-text mb-2">
                                <i class="fas fa-thermometer-half mr-2 ricoh-red-text"></i>Síntomas y Signos (opcional)
                            </label>
                            <textarea 
                                id="sintomas" 
                                name="sintomas" 
                                rows="3" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg input-ricoh resize-none"
                                placeholder="Ej: Poliuria, polidipsia, pérdida de peso, fatiga, visión borrosa..."
                            ></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>
                                Agregar síntomas mejora la precisión del código CIE-10
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium ricoh-dark-gray-text mb-2">
                                                                         <i class="fas fa-birthday-cake mr-2 ricoh-red-text"></i>Edad (opcional)
                                </label>
                                <input 
                                    type="number" 
                                    id="edad" 
                                    name="edad" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg input-ricoh"
                                    placeholder="65"
                                    min="0" 
                                    max="150"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium ricoh-dark-gray-text mb-2">
                                                                         <i class="fas fa-cogs mr-2 ricoh-red-text"></i>Modelo de IA
                                </label>
                                <select 
                                    id="modelo" 
                                    name="modelo" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg input-ricoh"
                                >
                                                                         <optgroup label="🏠 Modelos Locales (Ollama)">
                                         <option value="gpt-oss:120b">GPT-OSS 120B - Máxima precisión</option>
                                         <option value="gpt-oss:20b">GPT-OSS 20B - Alta precisión</option>
                                         <option value="gemma3:27b">Gemma3 27B - Alta precisión</option>
                                         <option value="gemma3:12b" selected>Gemma3 12B - Balanceado</option>
                                         <option value="gemma3:4b">Gemma3 4B - Rápido</option>
                                         <option value="deepseek-r1:8b">DeepSeek R1 8B - Especializado</option>
                                         <option value="qwen3:8b">Qwen3 8B - Buen rendimiento</option>
                                     </optgroup>
                                    <optgroup label="☁️ Modelos Cloud (OpenAI)">
                                        <option value="gpt-4-turbo">GPT-4 Turbo - Máxima precisión</option>
                                        <option value="gpt-4">GPT-4 - Alta precisión</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo - Buena precisión</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button 
                                type="submit" 
                                id="btnCodificar"
                                class="flex-1 btn-ricoh-primary font-medium py-3 px-6 rounded-lg flex items-center justify-center"
                            >
                                <i class="fas fa-magic mr-2"></i>
                                <span>Codificar con RAG + IA</span>
                            </button>
                            <button 
                                type="button" 
                                id="btnEjemplo"
                                class="btn-ricoh-secondary font-medium py-3 px-6 rounded-lg flex items-center justify-center"
                            >
                                <i class="fas fa-random mr-2"></i>
                                <span>Ejemplo</span>
                            </button>
                        </div>
                    </form>

                    <!-- Loading -->
                    <div id="loading" class="hidden mt-6">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="loading-pulse">
                                                                 <i class="fas fa-spinner fa-spin text-2xl ricoh-red-text"></i>
                            </div>
                            <div>
                                <p class="text-gray-600 font-medium">Procesando con RAG + IA...</p>
                                <p class="text-sm text-gray-500">Buscando códigos relevantes y analizando con IA</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="resultados" class="hidden mt-6">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                        <div class="flex items-center mb-6">
                            <i class="fas fa-clipboard-check text-2xl text-green-600 mr-3"></i>
                            <h3 class="text-xl font-semibold ricoh-dark-gray-text">Resultado de Codificación</h3>
                        </div>

                        <div id="resultadoContenido" class="space-y-6">
                            <!-- Contenido dinámico -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Lateral -->
            <div class="space-y-6">
                <!-- Información del Sistema RAG -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                                                 <i class="fas fa-database text-2xl ricoh-red-text mr-3"></i>
                        <h3 class="text-lg font-semibold ricoh-dark-gray-text">Sistema RAG</h3>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Diagnósticos:</span>
                            <span class="font-medium text-green-600">73,420 códigos</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Procedimientos:</span>
                                                         <span class="font-medium ricoh-red-text">78,496 códigos</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Búsqueda:</span>
                                                         <span class="font-medium ricoh-dark-red-text">~0.04s</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Precisión:</span>
                            <span class="font-medium text-green-600">>95%</span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                 <p class="text-xs ricoh-red-text">
                             <i class="fas fa-info-circle mr-1"></i>
                             El sistema RAG busca automáticamente los códigos más relevantes antes de procesar con IA
                         </p>
                    </div>
                </div>

                <!-- Códigos Sugeridos por RAG -->
                <div id="codigosRAG" class="hidden bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                                                 <i class="fas fa-search text-2xl ricoh-red-text mr-3"></i>
                        <h3 class="text-lg font-semibold ricoh-dark-gray-text">Códigos Sugeridos</h3>
                    </div>
                    
                    <div id="codigosRAGContenido" class="space-y-3">
                        <!-- Contenido dinámico -->
                    </div>
                </div>

                <!-- Estadísticas -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                                                 <i class="fas fa-chart-bar text-2xl ricoh-red-text mr-3"></i>
                        <h3 class="text-lg font-semibold ricoh-dark-gray-text">Estadísticas</h3>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tiempo total:</span>
                            <span id="tiempoTotal" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Motor IA:</span>
                            <span id="motorIA" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Confianza:</span>
                            <span id="confianza" class="font-medium">-</span>
                        </div>
                    </div>
                </div>

                <!-- Enlaces Útiles -->
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                                                 <i class="fas fa-link text-2xl ricoh-red-text mr-3"></i>
                        <h3 class="text-lg font-semibold ricoh-dark-gray-text">Enlaces Útiles</h3>
                    </div>
                    
                    <div class="space-y-2">
                                                 <a href="http://localhost:9999/health" target="_blank" class="flex items-center text-sm ricoh-red-text hover:text-red-800 transition-colors">
                            <i class="fas fa-heartbeat mr-2"></i>
                            Health Check
                        </a>
                                                 <a href="http://localhost:9999/models" target="_blank" class="flex items-center text-sm ricoh-red-text hover:text-red-800 transition-colors">
                            <i class="fas fa-cogs mr-2"></i>
                            Modelos Disponibles
                        </a>
                                                 <a href="http://localhost:9999/rag/search?query=diabetes" target="_blank" class="flex items-center text-sm ricoh-red-text hover:text-red-800 transition-colors">
                            <i class="fas fa-search mr-2"></i>
                            Búsqueda RAG
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Corporativo RICOH -->
    <footer class="ricoh-dark-gray text-white py-8 mt-12">
        <div class="container mx-auto px-6">
            <div class="text-center">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-8 h-8 bg-white rounded flex items-center justify-center mr-3">
                                                 <span class="text-sm font-bold ricoh-red-text">R</span>
                    </div>
                    <h3 class="text-lg font-bold">RICOH España</h3>
                </div>
                <p class="text-gray-300 mb-2">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Sistema IA Médica CIE-10-ES con RAG
                </p>
                <p class="text-sm text-gray-400">
                    Combina búsqueda semántica avanzada con modelos de IA para máxima precisión en codificación médica
                </p>
                <div class="mt-4 pt-4 border-t border-gray-600">
                    <p class="text-xs text-gray-500">
                        © 2024 RICOH España. Todos los derechos reservados.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const BACKEND_URL = 'http://localhost:9999';
        
        // Elementos del DOM
        const form = document.getElementById('codificacionForm');
        const btnCodificar = document.getElementById('btnCodificar');
        const btnEjemplo = document.getElementById('btnEjemplo');
        const loading = document.getElementById('loading');
        const resultados = document.getElementById('resultados');
        const codigosRAG = document.getElementById('codigosRAG');
        
        // Cargar ejemplo aleatorio
        async function cargarEjemplo() {
            try {
                const response = await fetch(`${BACKEND_URL}/ejemplos-clinicos/aleatorio`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('diagnostico').value = data.ejemplo;
                
                // Cargar síntomas si están disponibles
                if (data.sintomas) {
                    document.getElementById('sintomas').value = data.sintomas;
                } else {
                    // Ejemplos de síntomas comunes para diferentes diagnósticos
                    const diagnostico = data.ejemplo.toLowerCase();
                    if (diagnostico.includes('diabetes')) {
                        document.getElementById('sintomas').value = "Poliuria, polidipsia, pérdida de peso, fatiga, visión borrosa";
                    } else if (diagnostico.includes('hipertensión') || diagnostico.includes('hipertension')) {
                        document.getElementById('sintomas').value = "Dolor de cabeza, mareos, náuseas, visión borrosa, dolor en el pecho";
                    } else if (diagnostico.includes('neumonía') || diagnostico.includes('neumonia')) {
                        document.getElementById('sintomas').value = "Fiebre, tos, dificultad para respirar, dolor en el pecho, fatiga";
                    } else if (diagnostico.includes('gastritis')) {
                        document.getElementById('sintomas').value = "Dolor abdominal, náuseas, vómitos, pérdida de apetito, acidez";
                    } else {
                        document.getElementById('sintomas').value = "";
                    }
                }
            } catch (error) {
                console.error('Error cargando ejemplo:', error);
                // Cargar ejemplo por defecto si falla
                document.getElementById('diagnostico').value = "Paciente de 65 años con diabetes mellitus tipo 2";
                document.getElementById('sintomas').value = "Poliuria, polidipsia, pérdida de peso, fatiga, visión borrosa";
            }
        }
        
        // Formatear tiempo
        function formatearTiempo(segundos) {
            if (segundos < 1) return `${(segundos * 1000).toFixed(0)}ms`;
            return `${segundos.toFixed(2)}s`;
        }
        
        // Formatear confianza
        function formatearConfianza(confianza) {
            const porcentaje = (confianza * 100).toFixed(1);
            let color = 'text-red-600';
            if (confianza >= 0.8) color = 'text-green-600';
            else if (confianza >= 0.6) color = 'text-yellow-600';
            return `<span class="${color} font-medium">${porcentaje}%</span>`;
        }
        
        // Mostrar códigos RAG
        function mostrarCodigosRAG(codigos) {
            const container = document.getElementById('codigosRAGContenido');
            container.innerHTML = '';
            
            codigos.forEach((codigo, index) => {
                const similitud = (codigo.similarity * 100).toFixed(1);
                const card = document.createElement('div');
                                 card.className = 'p-3 border border-gray-200 rounded-lg hover:border-ricoh-red transition-colors';
                 card.innerHTML = `
                     <div class="flex justify-between items-start mb-2">
                         <span class="font-mono text-sm font-bold ricoh-red-text">${codigo.codigo}</span>
                         <span class="text-xs badge-ricoh-red px-2 py-1 rounded">${similitud}%</span>
                    </div>
                    <p class="text-xs text-gray-600 line-clamp-2">${codigo.descripcion}</p>
                    <div class="mt-2">
                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${codigo.tipo}</span>
                    </div>
                `;
                container.appendChild(card);
            });
            
            codigosRAG.classList.remove('hidden');
        }
        
        // Procesar formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const diagnostico = document.getElementById('diagnostico').value;
            const sintomas = document.getElementById('sintomas').value;
            const edad = document.getElementById('edad').value;
            const modelo = document.getElementById('modelo').value;
            
            if (!diagnostico.trim()) {
                alert('Por favor ingresa un diagnóstico');
                return;
            }
            
            // Combinar diagnóstico y síntomas para mejor contexto
            const contextoCompleto = sintomas.trim() 
                ? `${diagnostico}. Síntomas: ${sintomas}`
                : diagnostico;
            
            // Mostrar loading
            loading.classList.remove('hidden');
            resultados.classList.add('hidden');
            codigosRAG.classList.add('hidden');
            btnCodificar.disabled = true;
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutos
                
                const response = await fetch(`${BACKEND_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        diagnostico: contextoCompleto,
                        sintomas: sintomas.trim() || null,
                        edad: edad ? parseInt(edad) : null,
                        modelo: modelo
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Mostrar resultados
                mostrarResultados(data);
                
                // Mostrar códigos RAG si están disponibles
                if (data.codigos_sugeridos_rag) {
                    mostrarCodigosRAG(data.codigos_sugeridos_rag);
                }
                
                // Actualizar estadísticas
                document.getElementById('tiempoTotal').innerHTML = formatearTiempo(data.tiempo_procesamiento);
                document.getElementById('motorIA').textContent = data.motor_ia;
                document.getElementById('confianza').innerHTML = formatearConfianza(data.diagnostico_principal.confianza);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la solicitud. Verifica que el backend esté ejecutándose.');
            } finally {
                loading.classList.add('hidden');
                btnCodificar.disabled = false;
            }
        });
        
        // Mostrar resultados
        function mostrarResultados(data) {
            const container = document.getElementById('resultadoContenido');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Diagnóstico Principal -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-star text-green-600 mr-2"></i>
                            <h4 class="font-semibold text-green-800">Diagnóstico Principal</h4>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <span class="text-sm text-gray-600">Código:</span>
                                <span class="font-mono font-bold text-lg text-green-700 ml-2">${data.diagnostico_principal.codigo}</span>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Descripción:</span>
                                <p class="text-sm text-gray-800 mt-1">${data.diagnostico_principal.descripcion}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Justificación:</span>
                                <p class="text-sm text-gray-800 mt-1">${data.diagnostico_principal.justificacion}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Confianza:</span>
                                <span class="ml-2">${formatearConfianza(data.diagnostico_principal.confianza)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información del Sistema -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                                                     <i class="fas fa-cogs ricoh-red-text mr-2"></i>
                         <h4 class="font-semibold ricoh-red-text">Información del Sistema</h4>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Motor IA:</span>
                                <span class="font-medium">${data.motor_ia}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Base de datos:</span>
                                <span class="font-medium">${data.base_datos}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tiempo:</span>
                                <span class="font-medium">${formatearTiempo(data.tiempo_procesamiento)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contexto RAG -->
                ${data.contexto_rag ? `
                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                         <div class="flex items-center mb-3">
                         <i class="fas fa-database ricoh-red-text mr-2"></i>
                         <h4 class="font-semibold ricoh-red-text">Contexto RAG Utilizado</h4>
                    </div>
                    <pre class="text-xs text-blue-700 whitespace-pre-wrap">${data.contexto_rag}</pre>
                </div>
                ` : ''}
            `;
            
            resultados.classList.remove('hidden');
        }
        
        // Cargar ejemplo al hacer clic
        btnEjemplo.addEventListener('click', cargarEjemplo);
        
        // Cargar ejemplo al inicio
        cargarEjemplo();
    </script>
</body>
</html>
